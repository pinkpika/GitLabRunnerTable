<!DOCTYPE html>
<html>
    <head>
        <title>GitLab Runner Table</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    </head>
<body style="background-color:WhiteSmoke;">

    <!-- è¼¸å…¥å€ -->
    <div class="setting" style="margin:10px 10px;">
        <h5>ğŸŒ Domain</h5>
        <input type="text" id="domain" class="form-control form-control-dark" style="width: 300px;" placeholder="https://gitlab.example.com" aria-label="http://gitlab.example.com">
        <br/>
        <h5>ğŸ”‘ PRIVATE-TOKEN</h5>
        <input type="text" id="token" class="form-control form-control-dark" style="width: 300px;" placeholder="PRIVATE-TOKEN" aria-label="PRIVATE-TOKEN">   
        <br/>
        <h5>â±ï¸ Time Interval (å–è³‡æ–™çš„æ™‚é–“é€±æœŸ)(ç§’)</h5>
        <input type="text" id="inputTimeInterval" class="form-control form-control-dark" style="width: 300px;" placeholder="60" aria-label="60" value="60">
        <br/>
        <button class="btn btn-dark" onclick="onGetAllRunner()">Get All Runner!!</button>
    </div>

    <!-- éŒ¯èª¤å€ -->
    <div style="margin:10px 10px; padding:10px 10px; background-color:Gainsboro; border-radius:5px;">
        <h5>ğŸš« Error:</h5> 
        <label id="error"></label>
    </div>
    
    <!-- æ™‚é–“å€ -->
    <div class="time" style="margin:10px 10px; padding:10px 10px; background-color:Gainsboro; border-radius:5px;">
        <h5>â° Now Time (ç¾åœ¨æ™‚é–“): </h5> 
        <label id="nowTime"></label>
        <h5>â±ï¸ Last Data Time (ä¸Šæ¬¡Runnerè³‡æ–™æ™‚é–“): </h5> 
        <label id="lastDataTime"></label>
        <h5>â±ï¸ Time Interval (å–è³‡æ–™çš„æ™‚é–“é€±æœŸ)(ç§’): </h5>
        <label id="timeInterval"></label>
    </div>

    <!-- çµæœå€ -->
    <div class="result" style="margin:10px 10px;">
        <h4>ğŸ¤– Runner Table</h4> 
        <div class="result_table"></div>
    </div>
    
<script>

//ä¸Šæ¬¡è³‡æ–™æ™‚é–“
var lastDataTime = new Date(0, 0, 0);
//å·¥ä½œID(å–æ¶ˆå·¥ä½œç”¨)
var timeoutID = 0;
//æª¢æŸ¥é€±æœŸ(60s)
var timeInterval = 60; 

//æŒ‰ä¸‹æŒ‰éˆ•
function onGetAllRunner(){
    timeInterval = document.getElementById("inputTimeInterval").value; 
    document.querySelector("#timeInterval").innerHTML = `${timeInterval}`;
    window.clearInterval(timeoutID);
    lastDataTime = new Date(0, 0, 0);
    showNowTime()
}

//é¡¯ç¤ºç¾åœ¨æ™‚é–“
function showNowTime(){
    let nowTime = new Date();
    document.querySelector("#nowTime").innerHTML = `${nowTime}`;
    timeoutID = window.setTimeout('showNowTime()',1000);
    checkLastDataTime() //æ¯æ¬¡é¡¯ç¤ºæ™‚é–“æ™‚ï¼Œæª¢æŸ¥ä¸Šæ¬¡è³‡æ–™æ™‚é–“
}

//é¡¯ç¤ºæª¢æŸ¥æ™‚é–“
function showLastDataTime(){
    lastDataTime = new Date();
    document.querySelector("#lastDataTime").innerHTML = `${lastDataTime}`;
}

//æª¢æŸ¥ä¸Šæ¬¡è³‡æ–™æ™‚é–“
function checkLastDataTime(){
    let nowTime = new Date();
    var difference = nowTime.getTime() - lastDataTime.getTime();
    if(difference > (timeInterval * 1000)){
        getRunners();
        showLastDataTime();
    }
}

//å–å¾—Runners
function getRunners() {
    var domain = document.getElementById("domain").value;
    var token = document.getElementById("token").value;
    var myHeaders = new Headers();
    myHeaders.append("PRIVATE-TOKEN", token);
    var requestOptions = {
    method: 'GET',
    headers: myHeaders,
    redirect: 'follow'
    };
    fetch(domain+"/api/v4/runners?status=online", requestOptions)
    .then(response => response.text())
    .then(result => {
        console.log(result);
        document.querySelector("#error").innerHTML = ``;
        jsonToResultTable(result);
    })
    .catch(error => {
        console.log('error', error);
        document.querySelector("#error").innerHTML = `${error}`;
        window.clearInterval(timeoutID);
    });
}

//è¨­å®šResultTable
const jsonToResultTable = (json) => {
    json = JSON.parse(json);
    let title = `<thead><tr>${Object.keys(json[0]).map((el) => `<th>${el}</th>`).join('')}<th>RunningJob</th><th>link</th></tr></thead>`;
    console.log(title);
    let trs = json.map((el) => Object.values(el).map((td) => `<td>${td}</td>`).join('') + `<th id="runner_${el["id"]}_job"></th><th id="runner_${el["id"]}_link"></th></tr>` ); 
    console.log(trs);
    let tbody = `<tbody>${trs.map((el) => `<tr>${el}</tr>`).join('')}</tbody>`
    let table = `<table class="table table-dark">${title}${tbody}</table>`
    document.querySelector(".result_table").innerHTML = table;

    //å–å¾—RunningJob
    let runnerIds = json.map((el) => el["id"]);
    console.log(runnerIds);
    runnerIds.forEach(getJobs);
}

//å–å¾—RunningJob
function getJobs(runnerId) {
    var domain = document.getElementById("domain").value;
    var token = document.getElementById("token").value;
    var myHeaders = new Headers();
    myHeaders.append("PRIVATE-TOKEN", token);
    var requestOptions = {
    method: 'GET',
    headers: myHeaders,
    redirect: 'follow'
    };
    fetch(domain+"/api/v4/runners/"+runnerId+"/jobs?status=running", requestOptions)
    .then(response => response.text())
    .then(result => {
        console.log(result);
        document.querySelector("#error").innerHTML = ``;
        jsonToRunningJob(runnerId, result);
    })
    .catch(error => {
        console.log('error', error);
        document.querySelector("#error").innerHTML = `${error}`;
        window.clearInterval(timeoutID);
    });
}

//è¨­å®šRunningJob
const jsonToRunningJob = (runnerId, json) => {
    json = JSON.parse(json);
    if(json.length > 0){ 
        let jobId = json[0]["id"];
        let projectName = json[0]["project"]["name"];
        let webURL = json[0]["web_url"];
        console.log(jobId+" "+projectName+" "+webURL);
        document.querySelector("#runner_"+runnerId+"_job").innerHTML = projectName;
        document.querySelector("#runner_"+runnerId+"_link").innerHTML = `<a href="${webURL}" target="_blank" style="color:#36B6F5;">Link</a>`;
    } else {
        document.querySelector("#runner_"+runnerId+"_job").innerHTML = "None";
        document.querySelector("#runner_"+runnerId+"_link").innerHTML = "None";
    }
}

</script>

</body>
</html>
